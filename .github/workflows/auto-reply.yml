- name: Generate AI response using Gemini API
  id: ai
  run: |
    echo "ðŸ§  Extracting discussion context..."

    DISCUSSION=$(gh api repos/${REPO}/discussions/${DISCUSSION_NUMBER})
    DISCUSSION_TITLE=$(echo "$DISCUSSION" | jq -r '.title')
    DISCUSSION_BODY=$(echo "$DISCUSSION" | jq -r '.body')

    COMMENTS=$(gh api repos/${REPO}/discussions/${DISCUSSION_NUMBER}/comments | jq -r '.[].body' | paste -sd "\n---\n" -)

    echo "ðŸ“„ DISCUSSION_TITLE: $DISCUSSION_TITLE"
    echo "ðŸ“„ DISCUSSION_BODY: $DISCUSSION_BODY"
    echo "ðŸ’¬ COMMENTS: >>>$COMMENTS<<<"

    PROMPT=$(cat <<EOP
You are a helpful assistant responding to students' questions about software project ideas.

Here is the project description:
$PROJECT_DESC

Discussion title:
$DISCUSSION_TITLE

Initial post:
$DISCUSSION_BODY

Previous comments:
$COMMENTS

Please provide a clear and concise answer to the student's latest question:
$NEW_COMMENT
EOP
    )

    JSON_PAYLOAD=$(jq -n --arg prompt "$PROMPT" '{
      contents: [
        {
          role: "user",
          parts: [{ text: $prompt }]
        }
      ]
    }')

    RESPONSE=$(curl -s \
      -X POST "https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent" \
      -H "Content-Type: application/json" \
      -H "X-goog-api-key: ${{ secrets.GEMINI_API_KEY }}" \
      -d "$JSON_PAYLOAD")

    echo "ðŸ”Ž Raw API response:" && echo "$RESPONSE"

    echo "$RESPONSE" > response.json
    AI_REPLY=$(jq -r '.candidates[0].content.parts[0].text' response.json)

    echo "ðŸ§  AI Reply:" && echo "$AI_REPLY"

    printf "AI_REPLY<<EOF\n%s\nEOF\n" "$AI_REPLY" >> $GITHUB_ENV

- name: Post AI reply to discussion
  run: |
    echo "ðŸ“¨ Posting AI reply to discussion #$DISCUSSION_NUMBER in $REPO"
    gh api \
      repos/${REPO}/discussions/${DISCUSSION_NUMBER}/comments \
      -f body="$AI_REPLY"
